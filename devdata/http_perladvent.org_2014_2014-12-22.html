<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Language" content="en" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="WWW::AdventCalendar v1.109" />
    <link rel="alternate" title="Perl Advent Calendar 2014 XML feed" href="atom.xml" type="application/atom+xml" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <link rel="stylesheet" href="2014.css" type="text/css" />
    <title>
Perl Advent Calendar 2014 - 
A Holiday PAPR-ation

</title>
</head>
<body>
    <div id="contentwrapper">
        <div id="header">
            <h1><a href="index.html">Perl Advent Calendar 2014</a></h1>
        </div>

        <p id="tagline">twenty four merry days of Perl
          <a class='feed' href="atom.xml">Feed</a>
        </p>

        <div id="content">
          

<h1 class='title'>A Holiday PAPR-ation</h1>
<div class='subtitle'>Plack::App::Path::Router - 2014-12-22</div>

<div class='pod'><p>Jesse, Junior IT Elf Second Class grumbled to himself, &quot;Who even thought this was a good idea anyway.&quot; He had grabbed a ticket out of the North Pole&#39;s ticketing system, thinking that adding a simple new endpoint to an existing RESTful API would be a fairly trivial task. He had hoped to get out of the office early today, and instead he was staring at a creeping horror and the possibility of working all weekend.</p>

<p>Clearly, the code had originally started out as a very simple API of only a few endpoints. The original coder, either being in a hurry or just not knowing any better, had decided to implement it as a series of <code> if </code>-<code> elsif </code>-<code> else </code> blocks based on the first element in the URL string.</p>

<p>Now, 10 years later, there were dozens of <code> elsif </code> blocks, each with its own specialized handling of the subsequent parts of the URL. There was no overall organization to the code -- it seemed as if every time a new endpoint was required, the elf doing the work had just slapped in an <code> elsif </code> block whereever they felt like. The end result now had a structure something like this (only much worse -- the example is sanitized for a family audience):</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">CGI</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$cgi</span> <span class="operator">=</span> <span class="word">CGI</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">();</span><br /><br /><span class="keyword">my</span><span class="structure">(</span> <span class="symbol">$first</span> <span class="operator">,</span> <span class="symbol">@rest</span> <span class="structure">)</span> <span class="operator">=</span> <span class="symbol">$cgi</span><span class="operator">-&gt;</span><span class="word">path_info</span><span class="structure">();</span><br /><br /><span class="comment"># /present/present_id/action<br /></span><span class="keyword">if</span><span class="structure">(</span> <span class="symbol">$first</span> <span class="operator">eq</span> <span class="single">'present'</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;<span class="keyword">my</span><span class="structure">(</span> <span class="symbol">$id</span> <span class="operator">,</span> <span class="symbol">$action</span> <span class="structure">)</span> <span class="operator">=</span> <span class="symbol">@rest</span><span class="structure">;</span><br />&nbsp;&nbsp;<span class="word">validate_present_id</span><span class="structure">(</span> <span class="symbol">$id</span> <span class="structure">)</span> <span class="operator">or</span> <span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad id&quot;</span><span class="structure">);</span><br />&nbsp;&nbsp;<span class="keyword">if</span><span class="structure">(</span> <span class="symbol">$action</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad method&quot;</span><span class="structure">)</span> <span class="word">unless</span> <span class="symbol">$ENV</span><span class="structure">{</span><span class="word">REQUEST_METHOD</span><span class="structure">}</span> <span class="operator">eq</span> <span class="single">'POST'</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="symbol">$action</span> <span class="operator">=~</span> <span class="match">/^(add|update|delete)$/</span> <span class="operator">or</span> <span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad action&quot;</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">_handle_present_update</span><span class="structure">(</span> <span class="symbol">$id</span> <span class="operator">,</span> <span class="symbol">$action</span> <span class="structure">);</span><br />&nbsp;&nbsp;<span class="structure">}</span><br />&nbsp;&nbsp;<span class="keyword">else</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad method&quot;</span><span class="structure">)</span> <span class="word">unless</span> <span class="symbol">$ENV</span><span class="structure">{</span><span class="word">REQUEST_METHOD</span><span class="structure">}</span> <span class="operator">eq</span> <span class="single">'GET'</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">_handle_present_get</span><span class="structure">(</span> <span class="symbol">$id</span> <span class="structure">)</span><br />&nbsp;&nbsp;<span class="structure">}</span><br /><span class="structure">}</span><br /><span class="comment"># /good_child/child_id/reason<br /></span><span class="keyword">elsif</span><span class="structure">(</span> <span class="symbol">$first</span> <span class="operator">eq</span> <span class="single">'good_child'</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;<span class="keyword">my</span><span class="structure">(</span> <span class="symbol">$id</span> <span class="operator">,</span> <span class="symbol">$reason</span> <span class="structure">)</span> <span class="operator">=</span> <span class="symbol">@rest</span><span class="structure">;</span><br />&nbsp;&nbsp;<span class="word">validate_child_id</span><span class="structure">(</span> <span class="symbol">$id</span> <span class="structure">)</span> <span class="operator">or</span> <span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad id&quot;</span><span class="structure">);</span><br />&nbsp;&nbsp;<span class="word">validate_reason</span><span class="structure">(</span> <span class="symbol">$reason</span><span class="structure">)</span> <span class="operator">or</span> <span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad reason&quot;</span><span class="structure">);</span><br />&nbsp;&nbsp;<span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad method&quot;</span><span class="structure">)</span> <span class="word">unless</span> <span class="symbol">$ENV</span><span class="structure">{</span><span class="word">REQUEST_METHOD</span><span class="structure">}</span> <span class="operator">eq</span> <span class="single">'POST'</span><span class="structure">;</span><br />&nbsp;&nbsp;<span class="word">_handle_child_update</span><span class="structure">(</span> <span class="single">'good_child'</span> <span class="operator">,</span> <span class="symbol">$id</span> <span class="operator">,</span> <span class="symbol">$reason</span> <span class="structure">);</span><br /><span class="structure">}</span><br /><span class="comment"># /bad_child/child_id/reason<br /></span><span class="keyword">elsif</span><span class="structure">(</span> <span class="symbol">$first</span> <span class="operator">eq</span> <span class="single">'bad_child'</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;<span class="keyword">my</span><span class="structure">(</span> <span class="symbol">$id</span> <span class="operator">,</span> <span class="symbol">$reason</span> <span class="structure">)</span> <span class="operator">=</span> <span class="symbol">@rest</span><span class="structure">;</span><br />&nbsp;&nbsp;<span class="word">validate_child_id</span><span class="structure">(</span> <span class="symbol">$id</span> <span class="structure">)</span> <span class="operator">or</span> <span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad id&quot;</span><span class="structure">);</span><br />&nbsp;&nbsp;<span class="word">validate_reason</span><span class="structure">(</span> <span class="symbol">$reason</span><span class="structure">)</span> <span class="operator">or</span> <span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad reason&quot;</span><span class="structure">);</span><br />&nbsp;&nbsp;<span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad method&quot;</span><span class="structure">)</span> <span class="word">unless</span> <span class="symbol">$ENV</span><span class="structure">{</span><span class="word">REQUEST_METHOD</span><span class="structure">}</span> <span class="operator">eq</span> <span class="single">'POST'</span><span class="structure">;</span><br />&nbsp;&nbsp;<span class="word">_handle_child_update</span><span class="structure">(</span> <span class="single">'bad_child'</span> <span class="operator">,</span> <span class="symbol">$id</span> <span class="operator">,</span> <span class="symbol">$reason</span> <span class="structure">);</span><br /><span class="structure">}</span><br /><span class="keyword">else</span> <span class="structure">{</span><br />&nbsp;&nbsp;<span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;no match!&quot;</span><span class="structure">)</span><br /><span class="structure">}</span></code><br />&nbsp;</td></table>

<p>As Jesse sat and stared at screen after screen of cascading conditionals, grumbling and muttering to himself, his boss Margaret walked by and asked, &quot;What&#39;s going on, Jesse?&quot;</p>

<p>Jesse started to rant about the API code, but Margaret cut him off quickly. &quot;Listen, didn&#39;t you see the last memo that came out from the Big Guy? We&#39;re supposed to be replacing all those old CGIs with PSGIs when ever we have to make any changes to them. This is your lucky day, Junior! You get to clean up this mess. But we&#39;ve got apps deployed in the field that rely on this API, so make sure you don&#39;t change any of the endpoints while you&#39;re porting it over, or there will be heck to pay.&quot;</p>

<p>&quot;Fine&quot;, Jesse sighed. &quot;I guess I can go on <a href="https://metacpan.org/">MetaCPAN</a> and research the best way to...&quot;</p>

<p>Margaret cut him off again. &quot;No need, kid. Just use PAPR -- <a href="https://metacpan.org/module/Plack::App::Path::Router">Plack::App::Path::Router</a>!&quot;</p>

<p>Jesse sighed again as he pulled up the documentation on MetaCPAN. He learned that <a href="https://metacpan.org/module/Plack::App::Path::Router">Plack::App::Path::Router</a> provides a convenient way to take a <a href="https://metacpan.org/module/Path::Router">Path::Router</a> specification and wrap it up as a PSGI. Jesse was quickly able to turn the existing conditional cascade into a much more declarative set of <code> add_route </code> statements. He also quickly realized that he could replace all the custom validation routines in the old code with <code>Path::Router</code>&#39;s parameter extraction and <a href="https://metacpan.org/module/Moose">Moose</a>-style validations.</p>

<p>Within a few hours, Jesse had converted all the old style code to a form that looked like this:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Plack::App::Path::Router</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Path::Router</span><span class="structure">;</span><br /><br /><span class="keyword">my</span> <span class="symbol">$router</span> <span class="operator">=</span> <span class="word">Path::Router</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">();</span><br /><span class="comment"># note - formerly handled by a single conditional stanza; now split into two<br /></span><span class="symbol">$router</span><span class="operator">-&gt;</span><span class="word">add_route</span><span class="structure">(</span> <span class="single">'/present/:present_id'</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;<span class="word">validations</span> <span class="operator">=&gt;</span> <span class="structure">{</span> <span class="word">present_id</span> <span class="operator">=&gt;</span> <span class="single">'Int'</span> <span class="structure">}</span> <span class="operator">,</span><br />&nbsp;&nbsp;<span class="word">target</span>      <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br /><span class="comment">    # $request is a L&lt;Plack::Request&gt; object<br /></span>    <span class="keyword">my</span><span class="structure">(</span> <span class="symbol">$request</span> <span class="operator">,</span> <span class="symbol">$id</span> <span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad method&quot;</span><span class="structure">)</span> <span class="word">unless</span> <span class="symbol">$request</span><span class="operator">-&gt;</span><span class="word">method</span><span class="structure">()</span> <span class="operator">eq</span> <span class="single">'GET'</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">_handle_present_get</span><span class="structure">(</span> <span class="symbol">$id</span> <span class="structure">)</span><br />&nbsp;&nbsp;<span class="structure">}</span><br /><span class="structure">));</span><br /><br /><span class="symbol">$router</span><span class="operator">-&gt;</span><span class="word">add_route</span><span class="structure">(</span> <span class="single">'/present/:present_id/:action'</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;<span class="word">validations</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">present_id</span> <span class="operator">=&gt;</span> <span class="single">'Int'</span> <span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">action</span>     <span class="operator">=&gt;</span> <span class="regexp">qr/^(add|update|delete)$/</span> <span class="operator">,</span> <span class="comment"># validations can also be plain regexps</span><br />&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;<span class="word">target</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span><span class="structure">(</span> <span class="symbol">$request</span> <span class="operator">,</span> <span class="symbol">$id</span> <span class="operator">,</span> <span class="symbol">$action</span> <span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad method&quot;</span><span class="structure">)</span> <span class="word">unless</span> <span class="symbol">$request</span><span class="operator">-&gt;</span><span class="word">method</span><span class="structure">()</span> <span class="operator">eq</span> <span class="single">'POST'</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">_handle_present_update</span><span class="structure">(</span> <span class="symbol">$id</span> <span class="operator">,</span> <span class="symbol">$action</span> <span class="structure">);</span><br />&nbsp;&nbsp;<span class="structure">}</span><br /><span class="structure">));</span><br /><br /><span class="comment"># covers both /good_child/ and /bad_child/ endpoints<br /></span><span class="symbol">$router</span><span class="operator">-&gt;</span><span class="word">add_route</span><span class="structure">(</span> <span class="single">'/:child_type/:child_id/:reason'</span> <span class="structure">)</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;<span class="word">validations</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">child_type</span> <span class="operator">=&gt;</span> <span class="regexp">qr/^(good|bad)_child/</span> <span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">child_id</span>   <span class="operator">=&gt;</span> <span class="single">'Int'</span> <span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">reason</span>     <span class="operator">=&gt;</span> <span class="single">'Str'</span> <span class="operator">,</span><br />&nbsp;&nbsp;<span class="structure">}</span> <span class="operator">,</span><br />&nbsp;&nbsp;<span class="word">target</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span><span class="structure">(</span> <span class="symbol">$request</span> <span class="operator">,</span> <span class="symbol">$type</span> <span class="operator">,</span> <span class="symbol">$id</span> <span class="operator">,</span> <span class="symbol">$reason</span> <span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad method&quot;</span><span class="structure">)</span> <span class="word">unless</span> <span class="symbol">$request</span><span class="operator">-&gt;</span><span class="word">method</span><span class="structure">()</span> <span class="operator">eq</span> <span class="single">'POST'</span><span class="structure">;</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">_handle_child_update</span><span class="structure">(</span> <span class="symbol">$type</span> <span class="operator">,</span> <span class="symbol">$id</span> <span class="operator">,</span> <span class="symbol">$reason</span> <span class="structure">);</span><br />&nbsp;&nbsp;<span class="structure">}</span><br /><span class="structure">));</span><br /><br /><span class="comment"># now create the Plack app<br /></span><span class="keyword">my</span> <span class="symbol">$app</span> <span class="operator">=</span> <span class="word">Plack::App::Path::Router</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span> <span class="word">router</span> <span class="operator">=&gt;</span> <span class="symbol">$router</span> <span class="structure">);</span></code><br />&nbsp;</td></table>

<p>He commited his changes, and then added in one more change that added the new endpoint that had originally started him down this path. Work all done, he pushed his branch, and moved the ticket into the code review stage. While it had taken him a little longer than he expected, it still looked like he&#39;d be done early.</p>

<p>As he made one last scan over his email, Jesse realized that Margaret had already responded to his code review request ... and worse, she&#39;d rejected his changes! She was asking for something that was more data-driven and didn&#39;t have so much boilerplate code. Her suggestion was to look at <a href="https://metacpan.org/module/Plack::App::Path::Router::Custom">Plack::App::Path::Router::Custom</a> -- which Jesse dutifully pulled up on MetaCPAN. After a few minutes of reading, he saw exactly what she was talking about. He rapidly converted the previous version into this completely data-driven form:</p>



<table class='code-listing'><tr><td class='line-numbers'><br /><code>1:&nbsp;<br />2:&nbsp;<br />3:&nbsp;<br />4:&nbsp;<br />5:&nbsp;<br />6:&nbsp;<br />7:&nbsp;<br />8:&nbsp;<br />9:&nbsp;<br />10:&nbsp;<br />11:&nbsp;<br />12:&nbsp;<br />13:&nbsp;<br />14:&nbsp;<br />15:&nbsp;<br />16:&nbsp;<br />17:&nbsp;<br />18:&nbsp;<br />19:&nbsp;<br />20:&nbsp;<br />21:&nbsp;<br />22:&nbsp;<br />23:&nbsp;<br />24:&nbsp;<br />25:&nbsp;<br />26:&nbsp;<br />27:&nbsp;<br />28:&nbsp;<br />29:&nbsp;<br />30:&nbsp;<br />31:&nbsp;<br />32:&nbsp;<br />33:&nbsp;<br />34:&nbsp;<br />35:&nbsp;<br />36:&nbsp;<br />37:&nbsp;<br />38:&nbsp;<br />39:&nbsp;<br />40:&nbsp;<br />41:&nbsp;<br />42:&nbsp;<br />43:&nbsp;<br />44:&nbsp;<br />45:&nbsp;<br />46:&nbsp;<br />47:&nbsp;<br />48:&nbsp;<br />49:&nbsp;<br />50:&nbsp;<br />51:&nbsp;<br />52:&nbsp;<br />53:&nbsp;<br />54:&nbsp;<br />55:&nbsp;<br />56:&nbsp;<br />57:&nbsp;</code><br />&nbsp;</td><td class='code'><br /><code><span class="keyword">use</span> <span class="word">Path::Router</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Plack::App::Path::Router</span><span class="structure">;</span><br /><span class="keyword">use</span> <span class="word">Plack::Request</span><span class="structure">;</span><br /><br /><span class="keyword">use</span> <span class="word">SantasWorkshop::API</span><span class="structure">;</span>  <span class="comment"># all the '_handle' methods were migrated to here</span><br /><br /><span class="comment"># each entry is 'route definition' =&gt; 'method' =&gt; 'hashref of options'<br /></span><span class="keyword">my</span> <span class="symbol">@routes</span> <span class="operator">=</span> <span class="structure">(</span><br />&nbsp;&nbsp;<span class="structure">[</span> <span class="single">'/present/:present_id'</span> <span class="operator">=&gt;</span> <span class="single">'handle_present_get'</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">methods</span>     <span class="operator">=&gt;</span> <span class="structure">{</span> <span class="single">'GET'</span> <span class="operator">=&gt;</span> <span class="number">1</span> <span class="structure">}</span> <span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">validations</span> <span class="operator">=&gt;</span> <span class="structure">{</span> <span class="word">present_id</span> <span class="operator">=&gt;</span> <span class="single">'Int'</span> <span class="structure">}</span> <span class="operator">,</span><br />&nbsp;&nbsp;<span class="structure">}]</span> <span class="operator">,</span><br /><br />&nbsp;&nbsp;<span class="structure">[</span> <span class="single">'/present/:present_id/:action'</span> <span class="operator">=&gt;</span> <span class="single">'handle_present_update'</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">methods</span>     <span class="operator">=&gt;</span> <span class="structure">{</span> <span class="single">'POST'</span> <span class="operator">=&gt;</span> <span class="number">1</span> <span class="structure">}</span> <span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">validations</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">present_id</span> <span class="operator">=&gt;</span> <span class="single">'Int'</span> <span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">action</span>     <span class="operator">=&gt;</span> <span class="regexp">qr/^(add|update|delete)$/</span> <span class="operator">,</span> <span class="comment"># validations can also be plain regexpsld</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><span class="operator">,</span><br />&nbsp;&nbsp;<span class="structure">}]</span> <span class="operator">,</span><br /><br /><span class="comment">  # covers both /good_child/ and /bad_child/ endpoints<br /></span>  <span class="structure">[</span> <span class="single">'/:child_type/:child_id/:reason'</span> <span class="operator">=&gt;</span> <span class="single">'handle_child_update'</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">methods</span>     <span class="operator">=&gt;</span> <span class="structure">{</span> <span class="single">'POST'</span> <span class="operator">=&gt;</span> <span class="number">1</span> <span class="structure">}</span> <span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">validations</span> <span class="operator">=&gt;</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">child_type</span> <span class="operator">=&gt;</span> <span class="regexp">qr/^(good|bad)_child/</span> <span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">child_id</span>   <span class="operator">=&gt;</span> <span class="single">'Int'</span> <span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">reason</span>     <span class="operator">=&gt;</span> <span class="single">'Str'</span> <span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span> <span class="operator">,</span><br />&nbsp;&nbsp;<span class="structure">}]</span> <span class="operator">,</span><br /><span class="structure">)</span><br /><br /><span class="comment"># dynamically build the routing table based on the @routes data structure<br /></span><span class="keyword">my</span> <span class="symbol">$router</span> <span class="operator">=</span> <span class="word">Path::Router</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">();</span><br /><span class="keyword">foreach</span> <span class="structure">(</span><span class="symbol">@routes</span><span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span> <span class="symbol">$endpoint</span><span class="operator">,</span> <span class="symbol">$action</span><span class="operator">,</span> <span class="symbol">$options</span> <span class="structure">)</span> <span class="operator">=</span> <span class="cast">@</span><span class="magic">$_</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;<span class="symbol">$router</span><span class="operator">-&gt;</span><span class="word">add_route</span><span class="structure">(</span> <span class="symbol">$endpoint</span> <span class="operator">=&gt;</span> <span class="structure">(</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">target</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="structure">(</span> <span class="symbol">$request</span><span class="operator">,</span> <span class="symbol">@rest</span> <span class="structure">)</span> <span class="operator">=</span> <span class="magic">@_</span><span class="structure">;</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> <span class="structure">(</span> <span class="word">exists</span> <span class="symbol">$options</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">methods</span><span class="structure">}</span> <span class="structure">)</span> <span class="structure">{</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">my</span> <span class="symbol">$request_method</span> <span class="operator">=</span> <span class="symbol">$request</span><span class="operator">-&gt;</span><span class="word">method</span><span class="structure">();</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">return_error</span><span class="structure">(</span><span class="double">&quot;bad method&quot;</span><span class="structure">)</span> <span class="word">unless</span> <span class="symbol">$options</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">methods</span><span class="structure">}{</span><span class="symbol">$request_method</span><span class="structure">};</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="word">SantasWorkshop::API</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">()</span><span class="operator">-&gt;</span><span class="symbol">$action</span><span class="structure">(</span><span class="symbol">@rest</span><span class="structure">);</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="structure">}</span> <span class="operator">,</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span class="word">validations</span> <span class="operator">=&gt;</span> <span class="symbol">$options</span><span class="operator">-&gt;</span><span class="structure">{</span><span class="word">validations</span><span class="structure">}</span> <span class="operator">,</span><br />&nbsp;&nbsp;<span class="structure">));</span><br /><span class="structure">}</span><br /><br /><span class="comment"># once the routing table is all build, make the app using that router.<br /></span><span class="keyword">my</span> <span class="symbol">$app</span> <span class="operator">=</span> <span class="word">Plack::App::Path::Router::Custom</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><br />&nbsp;&nbsp;<span class="word">router</span>      <span class="operator">=&gt;</span> <span class="symbol">$router</span><span class="operator">,</span><br />&nbsp;&nbsp;<span class="word">new_request</span> <span class="operator">=&gt;</span> <span class="keyword">sub</span> <span class="structure">{</span> <span class="word">Plack::Request</span><span class="operator">-&gt;</span><span class="word">new</span><span class="structure">(</span><span class="core">shift</span><span class="structure">)</span> <span class="structure">}</span> <span class="operator">,</span><br /><span class="structure">);</span></code><br />&nbsp;</td></table>

<p>Jesse pushed the final revision up for code review and got notification of Margaret&#39;s merging of the code into the release branch only a few minutes later -- along with an IM saying, &quot;Nice work, kid -- how about you take off early today.&quot;</p>

<h2 id="See-Also">See Also</h2>

<ul>

<li><p><a href="https://metacpan.org/module/Plack::App::Path::Router">Plack::App::Path::Router</a></p>

</li>
<li><p><a href="https://metacpan.org/module/Path::Router">Path::Router</a></p>

</li>
<li><p><a href="https://metacpan.org/module/Plack::App::Path::Router::Custom">Plack::App::Path::Router::Custom</a></p>

</li>
<li><p><a href="https://metacpan.org/module/Plack">Plack</a></p>

</li>
<li><p><a href="http://perladvent.org/2014/2014-12-04.html">The Perl Advent Article on PSGI and Plack</a></p>

</li>
</ul>

</div>

<div id='author'>
<img alt='Gravatar Image' style='vertical-align:middle' src=http://www.gravatar.com/avatar/d07c1f81d10a1d147d6b5cb80fa1c654?r=g&s=80&d=retro />
This article contributed by: John SJ Anderson &lt;genehack@genehack.org&gt;
</div>


<ul id="pager">
    <li class="previous"><a title="Beyond Grep" href="2014-12-21.html">Previous</a></li>

    <li class="next"><a title="CLDR TL;DR" href="2014-12-23.html">Next</a></li>
</ul>
<div style="clear: both"></div>

        </div>
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-27056407-1");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>



